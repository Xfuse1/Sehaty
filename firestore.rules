/**
 * @fileoverview Firestore Security Rules for the Sehaty application.
 *
 * Core Philosophy:
 * This ruleset prioritizes security and data ownership. It enforces a strict user-ownership model for personal data while allowing public read access to certain collections. Admin-only write access is granted for public data collections like doctors, clinics, etc.
 *
 * Data Structure:
 * The Firestore data is organized with user-specific data nested under `/users/{userId}`.
 * Publicly accessible data (e.g., pharmacies, doctors) resides in top-level collections.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the owning user.
 * - Public data is readable by all authenticated users, but writable only by admins.
 * - Listing all users is disallowed.
 * - Admin access is controlled via custom authentication tokens with an `isAdmin` claim.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines whether the current user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the signed-in user is an administrator.
     * It relies on a custom claim `isAdmin` in the user's authentication token.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return request.auth.token.isAdmin == true;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to check against the request's authentication UID.
     * @return {bool} True if the user ID matches the request's authentication UID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the existing owner of the resource and the resource exists.
     * @param {string} userId The user ID to check against the resource's owner ID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for user profiles.
     * Enforces document ownership for all write operations.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Disallow listing all users for security reasons.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for pharmacies.
     * Allows public read access but restricts write access to admins.
     */
    match /pharmacies/{pharmacyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Security rules for physiotherapy packages.
     * Allows public read access but restricts write access to admins.
     */
    match /physiotherapyPackages/{packageId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Security rules for appointments within a user's profile.
     * Enforces document ownership for all operations.
     */
    match /users/{userId}/appointments/{appointmentId} {
      allow get, list, create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for generic bookings within a user's profile.
     * Enforces document ownership for all operations.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow get, list, create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for doctors.
     * Allows public read access but restricts write access to admins.
     */
    match /doctors/{doctorId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Security rules for clinics.
     * Allows public read access but restricts write access to admins.
     */
    match /clinics/{clinicId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Security rules for nursing care packages.
     * Allows public read access but restricts write access to admins.
     */
    match /nursingCarePackages/{packageId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Security rules for lab tests.
     * Allows public read access but restricts write access to admins.
     */
    match /labTests/{labTestId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Security rules for lab test bookings within a user's profile.
     * Enforces document ownership for all operations.
     */
    match /users/{userId}/labTestBookings/{labTestBookingId} {
      allow get, list, create: if isSignedIn() && isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for radiology tests.
     * Allows public read access but restricts write access to admins.
     */
    match /radiology/{radiologyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin();
    }
  }
}
